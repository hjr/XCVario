/*
 * Polars.cpp
 *
 *  Created on: Mar 1, 2019
 *      Author: iltis
 *
 *      Class to deliver a library of default polars
 */

#include "Polars.h"
#include "SetupNG.h"
#include "logdef.h"

#include <cinttypes>
#include <string_view>

// Format per glider:  { Index, GliderType, Reference Wingload (kg/m2), speed1 (km/h), sink1 (m/s), speed2, sink2, speed3, sink3 , max ballast [liters or kg], wing area [m2] },

struct compressed_polar {
	uint16_t index;
	std::string_view type;
	uint16_t wingload;		// 1/100x kg/mxm
	uint8_t  speed1;		// km/h
	int16_t  sink1;			// 1/100x m/s
	uint8_t  speed2;		// km/h
	int16_t  sink2;			// 1/100x m/s
	uint8_t  speed3;		// km/h
	int16_t  sink3;			// 1/100x m/s
	uint8_t  max_ballast;	// 2x kg
	uint16_t wingarea;		// 1/100x mxm
};


constexpr const compressed_polar polars_default_arr[] = {
	{ 1000, "User Polar", 3440,  80,  -66, 125,  -97, 175, -224,  80,  1050 },
	{ 1010, "Antares 20E", 4286, 100,  -53, 140,  -76, 200, -179, 108,  1260 },
	{ 1020, "Apis 2", 2580,  80,  -60, 100,  -75, 142, -150,   0,  1240 },
	{ 1025, "Apis Bee 15MB", 2635,  84,   59, 140,  121, 220, -400,   0,  1224 },
	{ 1030, "Arcus", 4490, 110,  -64, 140,  -88, 180, -147,  92,  1559 },
	{ 1035, "ASK 18", 2400,  75,  -61, 138, -177, 200, -423,   0,  1299 },
	{ 1050, "ASK 21", 3130,  80,  -76, 125, -121, 175, -275,   0,  1795 },
	{ 1060, "ASK 23", 2630,  80,  -69, 125, -132, 175, -293,   0,  1290 },
	{ 1070, "ASK 13", 2171,  70,  -80, 100, -120, 150, -280,   0,  1750 },
	{ 1078, "ASH 25", 4150, 100,  -54, 140,  -96, 185, -179,  60,  1631 },
	{ 1080, "ASH 25e", 4300,  80,  -62, 125,  -72, 175, -149,  60,  1631 },
	{ 1090, "ASH 31Mi/18", 4230,  90,  -45, 150,  -97, 200, -202,  60,  1183 },
	{ 1100, "ASH 31Mi/21", 3879,  90,  -55, 150,  -99, 200, -232,  70,  1316 },
	{ 1110, "ASW 15B", 2770,  80,  -63, 120, -116, 150, -200,  45,  1100 },
	{ 1120, "ASW 17", 3200,  80,  -55, 125,  -82, 175, -178,  50,  1484 },
	{ 1130, "ASW 19", 3150,  80,  -63, 125, -109, 175, -244,  50,  1050 },
	{ 1140, "ASW 20", 3360,  80,  -62, 125,  -92, 175, -183,  60,  1050 },
	{ 1150, "ASW 20A", 3590,  80,  -69, 125, -105, 175, -225,  60,  1050 },
	{ 1160, "ASW 20C", 3325,  80,  -61, 125,  -94, 175, -188,  60,  1050 },
	{ 1170, "ASW 20L", 3229,  80,  -57, 125,  -93, 175, -201,  60,  1105 },
	{ 1180, "ASW 22/24", 3279,  80,  -43, 125,  -85, 175, -177, 120,  1490 },
	{ 1190, "ASW 22M", 4020,  80,  -51, 125,  -75, 175, -160,  92,  1631 },
	{ 1200, "ASW 24", 3500, 109,  -73, 142, -121, 167, -176,  78,  1000 },
	{ 1210, "ASW 24WL", 3570, 109,  -64, 156, -118, 211, -254,  78,  1000 },
	{ 1215, "ASW 27", 4054,  89,  -60, 130,  -85, 170, -161,  82,   900 },
	{ 1220, "ASW 28", 3142,  90,  -57, 130, -105, 170, -215,  95,  1050 },
	{ 1230, "B4 P-11", 2490,  80,  -65, 110, -166, 150, -238,   0,  1405 },
	{ 1240, "Blanik L13", 2580,  80,  -70, 150, -245, 200, -500,   0,  1915 },
	{ 1250, "Calif A21S", 3920,  80,  -69, 125,  -93, 175, -182,   0,  2350 },
	{ 1252, "CB-15 Crystal", 3100,  80,  -60, 118, -100, 180, -300,  50,   977 },
	{ 1255, "Carat A", 4442, 105,  -75, 160, -200, 200, -390,   0,  1058 },
	{ 1260, "Cirrus Std", 3060,  80,  -64, 125, -118, 175, -259,  30,  1004 },
	{ 1270, "Cirrus 17.7m", 2850,  75,  -50, 120, -100, 160, -183,  49,  1260 },
	{ 1280, "DG 100", 3000,  80,  -62, 125, -116, 175, -268,  50,  1100 },
	{ 1290, "DG 100G", 3048,  80,  -64, 125, -113, 175, -250,  50,  1100 },
	{ 1300, "DG 200", 3400,  80,  -65, 125,  -97, 175, -205,  60,  1000 },
	{ 1310, "DG 300", 3320,  80,  -60, 125, -102, 175, -248,  65,  1028 },
	{ 1320, "DG 400/17", 3840,  80,  -55, 125, -101, 175, -212,  45,  1000 },
	{ 1330, "DG 500M/22", 4000,  80,  -51, 142, -100, 180, -175,  50,  1829 },
	{ 1340, "DG 600/15", 3329,  85,  -57, 130, -100, 180, -186,  94,  1095 },
	{ 1350, "DG 600/18", 3200,  80,  -50, 136, -100, 180, -180,  94,  1181 },
	{ 1360, "DG 800B/15", 3876,  97,  -61, 130,  -93, 170, -159,  50,  1068 },
	{ 1370, "DG 800S/15", 3493,  92,  -58, 130,  -97, 170, -169,  75,  1068 },
	{ 1380, "DG 800B/18", 3539,  85,  -52, 130,  -84, 170, -156,  50,  1181 },
	{ 1390, "DG 800S/18", 2997,  78,  -48, 130,  -92, 170, -178,  75,  1181 },
	{ 1410, "DG 1000S/20", 2800,  80,  -51, 125,  -93, 175, -280,  80,  1753 },
	{ 1420, "Diamant 18", 2800,  72,  -52, 125,  -95, 160, -175,  25,  1428 },
	{ 1425, "Diana2", 3210,  75,  -48, 120,  -82, 180, -222, 120,   864 },
	{ 1430, "Discus A", 2967,  80,  -56, 125, -100, 175, -255, 100,  1058 },
	{ 1440, "Discus 2B", 5170, 100,  -75, 125,  -80, 175, -150, 100,  1016 },
	{ 1445, "Discus 2C 18m", 3319, 100,  -57, 120,  -76, 150, -133, 100,  1136 },
	{ 1450, "DUO Discus", 3050,  80,  -52, 130, -100, 177, -250,  99,  1640 },
	{ 1460, "Elfe S4D", 2700,  80,  -69, 125, -123, 175, -276,   0,  1180 },
	{ 1470, "Genesis II", 3354,  94,  -61, 141, -118, 172, -196,   0,  1150 },
	{ 1480, "G-102 CS", 3000,  80,  -61, 125, -107, 175, -245,  50,  1240 },
	{ 1490, "G-102 CS Top", 3475,  80,  -70, 125, -118, 175, -255,   0,  1240 },
	{ 1500, "G-102 Club", 2900,  80,  -70, 125, -118, 175, -255,   0,  1240 },
	{ 1510, "G-102 3B", 2760,  80,  -68, 125, -134, 175, -284,   0,  1240 },
	{ 1520, "G-102 Twin", 3340,  80,  -78, 125, -107, 175, -217,   0,  1780 },
	{ 1530, "G-103 Twin", 2760,  80,  -75, 120, -100, 200, -340,   0,  1752 },
	{ 1532, "G-109B", 4470, 105, -110, 160, -200, 200, -400,   0,  1900 },
	{ 1535, "H-304/17", 3520,  80,  -53, 125,  -93, 175, -193,  58,  1068 },
	{ 1540, "H-304", 3579,  80,  -64, 125,  -96, 175, -204,  58,   988 },
	{ 1550, "Hornet C", 3229,  80,  -63, 125, -112, 175, -255,  50,   980 },
	{ 1560, "Hornet H-206", 3204,  80,  -64, 125, -112, 175, -249,  50,   980 },
	{ 1570, "Jantar 2B", 3320,  80,  -51, 125,  -87, 175, -202,  84,  1430 },
	{ 1580, "Jantar Std", 3350,  80,  -68, 125, -107, 175, -225,  50,  1424 },
	{ 1590, "Jantar Std 3", 3058,  95,  -66, 180, -225, 220, -385,  75,  1066 },
	{ 1595, "Jantar SZD 38A", 2770,  91,  -53, 140, -127, 180, -226,  50,  1340 },
	{ 1600, "Jantar SZD 41A", 3090,  80,  -62, 125, -110, 175, -241,   0,  1066 },
	{ 1610, "Janus", 3110,  80,  -69, 125, -104, 175, -208, 120,  1660 },
	{ 1620, "Janus CM", 3900,  90,  -64, 120,  -78, 180, -180,   0,  1730 },
	{ 1630, "Jeans Astir ", 2968,  80,  -73, 125, -127, 175, -278,   0,  1240 },
	{ 1640, "JS1 18m", 3600, 110,  -55, 160, -120, 200, -220,  95,  1119 },
	{ 1650, "JS1 21m", 3600, 110,  -50, 160, -118, 200, -220, 107,  1225 },
	{ 1660, "Ka 6b R/S ", 2220,  80,  -76, 125, -175, 175, -430,   0,  1240 },
	{ 1670, "Ka 6 CR", 2419,  80,  -70, 125, -168, 150, -270,   0,  1240 },
	{ 1680, "Ka 7", 2660,  80,  -94, 125, -180, 175, -455,   0,  1740 },
	{ 1690, "Ka 8", 2102,  60,  -65, 120, -210, 150, -380,   0,  1415 },
	{ 1700, "Kestrel 17", 3170,  80,  -59, 125,  -98, 175, -201,  25,  1158 },
	{ 1710, "Kestrel 19", 3340,  80,  -57, 125,  -93, 175, -203,  50,  1287 },
	{ 1720, "Kestrel 22", 3579,  80,  -53, 125,  -81, 175, -174,  50,  1626 },
	{ 1730, "Standard Libelle", 3570,  80,  -68, 120, -110, 175, -260,  25,   980 },
	{ 1740, "Club Libelle 205", 3370,  80,  -66, 124, -120, 176, -277,   0,   980 },
	{ 1750, "LAK-12 (20.4m)", 2940,  75,  -48, 120,  -80, 170, -195,  95,  1463 },
	{ 1760, "LAK-17 (15m)", 3145, 100,  -60, 120,  -72, 150, -109, 108,   906 },
	{ 1780, "LAK-17a (15m)", 3145,  95,  -57, 148, -131, 200, -288,  90,   906 },
	{ 1790, "LAK-17 (18m)", 3010, 100,  -56, 120,  -74, 150, -116, 102,   980 },
	{ 1800, "LAK-17a (18m)", 3672,  85,  -50, 140, -100, 180, -182,  90,   980 },
	{ 1810, "Lambada (15m)", 3488,  80, -100, 140, -240, 200, -480,   0,  1290 },
	{ 1820, "LS 3a", 3260,  80,  -63, 125,  -96, 175, -290,  75,  1050 },
	{ 1830, "LS 1 f", 3550,  80,  -64, 125, -107, 175, -234,   0,   974 },
	{ 1840, "LS 3 15m", 3550,  80,  -63, 125,  -92, 175, -187,  75,  1050 },
	{ 1850, "LS 3 17m", 3300,  80,  -56, 125,  -94, 175, -244,   0,  1122 },
	{ 1851, "LS 3 WL", 3770,  80,  -60, 130,  -92, 180, -175,  75,  1050 },
	{ 1860, "LS 4", 3440,  80,  -66, 125,  -97, 175, -224,  80,  1050 },
	{ 1870, "LS 6a", 3329, 100,  -67, 155, -148, 212, -300,  70,  1050 },
	{ 1880, "LS 6 18w", 3900, 100,  -68, 150,  -91, 200, -225,  70,  1142 },
	{ 1881, "LS 6 neo", 3438, 100,  -65, 130,  -93, 160, -144,  70,  1050 },
	{ 1890, "LS 7 WL", 3597, 104,  -73, 156, -147, 180, -266,  75,   973 },
	{ 1900, "LS 8", 3428, 100,  -67, 155, -145, 185, -250,  88,  1050 },
	{ 1905, "LS 8 neo", 3590, 100,  -67, 130,  -90, 160, -148,  95,  1050 },
	{ 1910, "LS 9", 4500, 100,  -69, 150,  -86, 200, -175,  70,  1142 },
	{ 1920, "L-Spatz 55", 2222,  80,  -80, 100, -125, 125, -230,   0,  1170 },
	{ 1930, "Marianne", 3782,  80,  -50, 140, -150, 200, -360,   0,  1718 },
	{ 1940, "MG-23", 2530,  78,  -70, 110, -140, 140, -215,   0,  1421 },
	{ 1950, "Mini Nimbus", 3420,  80,  -63, 125,  -96, 175, -213,  62,   986 },
	{ 1960, "MiniLak FES", 4079,  90,  -69, 120,  -87, 180, -206,  40,   841 },
	{ 1970, "Mistral C", 3136,  80,  -67, 125, -115, 175, -264,   0,  1090 },
	{ 1980, "Mosquito", 3620,  80,  -63, 125,  -92, 175, -199,  58,   986 },
	{ 1990, "Mosquito B", 3400,  80,  -62, 125,  -93, 175, -204,  58,   986 },
	{ 2000, "Nimbus 2", 3000,  80,  -50, 125,  -88, 175, -200,  80,  1440 },
	{ 2010, "Nimbus 3", 2950,  80,  -46, 125,  -88, 175, -185, 169,  1628 },
	{ 2020, "Nimbus 3DM", 4817,  95,  -50, 130,  -70, 187, -160,  84,  1702 },
	{ 2030, "Nimbus 3/24.5", 2890,  80,  -39, 125,  -86, 175, -187, 169,  1670 },
	{ 2040, "Nimbus 4/26.5", 3342,  85,  -41, 128,  -75, 163, -140, 150,  1786 },
	{ 2045, "Nimbus 4DM", 4606, 100,  -48, 150,  -87, 191, -160,  84,  1780 },
	{ 2050, "Phoebus B", 2460,  80,  -60, 125, -110, 175, -240,  40,  1316 },
	{ 2060, "Piccolo B", 2689,  68,  -90,  78, -100, 111, -200,   0,  1060 },
	{ 2070, "Pegase 101A", 3279,  80,  -63, 125, -108, 175, -254,  50,  1200 },
	{ 2080, "Pik 20B", 3540, 102,  -69, 158, -159, 217, -360,  70,  1000 },
	{ 2090, "Pik 20E", 4370, 110,  -83, 167, -200, 241, -470,  60,  1000 },
	{ 2100, "Pik 20D", 3250,  80,  -66, 125, -106, 175, -220,  70,  1000 },
	{ 2105, "PW-5", 2952,  73,  -64, 125, -160, 160, -320,   0,  1016 },
	{ 2110, "Salto 13,6m", 3160,  80,  -72, 125, -132, 175, -296,   0,   858 },
	{ 2120, "Salto 15m", 3120,  80,  -62, 125, -124, 175, -275,   0,   914 },
	{ 2130, "Salto 15,5m", 3400,  80,  -62, 125, -121, 175, -273,   0,   914 },
	{ 2140, "SB-10", 3670,  80,  -48, 125,  -82, 175, -174,  50,  2295 },
	{ 2150, "SB-11", 3690,  80,  -68, 125,  -91, 175, -184,  52,  1056 },
	{ 2160, "SB-12", 3320,  80,  -60, 125,  -99, 175, -236,  75,  1002 },
	{ 2170, "SF 25B", 3090,  75, -113, 111, -210, 135, -310,   0,  1750 },
	{ 2180, "SF 27", 2600,  74,  -64, 105, -100, 175, -250,   0,  1200 },
	{ 2190, "SF 27M", 3000,  80,  -72, 115, -100, 175, -220,   0,  1200 },
	{ 2200, "SF 34", 3610,  80,  -90, 125, -119, 175, -254,   0,  1480 },
	{ 2210, "SFS 31", 3579,  85,  -85, 127, -150, 150, -215,   0,  1200 },
	{ 2220, "Silent Club", 2520,  65,  -62, 115, -105, 175, -320,   0,  1030 },
	{ 2222, "Std Austria S", 2200,  70,  -70, 118, -100, 145, -150,   0,  1350 },
	{ 2225, "Stratos II", 1717,  50,  -95,  65, -113, 100, -250,  25,  1630 },
	{ 2230, "Sunrise II", 2600,  65, -120, 100, -180, 130, -300,   0,  1540 },
	{ 2235, "Song 120", 2373,  70, -100,  85, -120, 120, -300,   0,   990 },
	{ 2237, "SZD50 Puch.", 2395, 100, -100, 120, -142, 150, -235,  68,  1816 },
	{ 2240, "SZD51-1 Jun.", 3038,  80,  -65, 125, -120, 175, -280,   0,  1251 },
	{ 2250, "SZD55", 5208,  85,  -90, 125,  -86, 175, -150,  98,   960 },
	{ 2252, "SZD54-2 17m", 2702,  98,  -92, 174, -435, 250, -1322,   0,  1636 },
	{ 2253, "SZD54-2 17m WL", 2702,  99,  -86, 175, -422, 250, -1301,   0,  1636 },
	{ 2254, "SZD54-2 20m WL", 2554,  91,  -69, 170, -398, 250, -1266,   0,  1730 },
	{ 2260, "Taurus", 3736,  94,  -70, 108,  -75, 180, -220,   0,  1262 },
	{ 2265, "T65 15m", 3029,  75,  -62, 125, -100, 200, -310,  44,  1010 },
	{ 2270, "Ventus A", 3500,  80,  -60, 125,  -87, 175, -185,  84,   951 },
	{ 2280, "Ventus A-B/16.6", 3250,  80,  -53, 125,  -93, 175, -197,  84,   996 },
	{ 2290, "Ventus B", 3500,  80,  -58, 125,  -88, 175, -193,  84,   951 },
	{ 2300, "Ventus C", 3300,  80,  -52, 120,  -75, 180, -200,  84,  1015 },
	{ 2310, "VSO 10", 2890,  83,  -65, 120, -105, 160, -228,   0,  1200 },
	{ 2320, "1comet FG", 2000,  64,  -42,  86,  -60, 120, -100,   0,  1125 },
	{ 2330, "1comet RG", 2000,  64,  -46,  86,  -66, 120, -110,   0,  1125 }
};


t_polar::t_polar(const compressed_polar *cp)
{
	index = cp->index;
	type = cp->type.data();
	wingload = (float)(cp->wingload) / 100.f;
	speed1 = (float)(cp->speed1);
	sink1 = (float)(cp->sink1) / 100.f;
	speed2 = (float)(cp->speed2);
	sink2 = (float)(cp->sink2) / 100.f;
	speed3 = (float)(cp->speed3);
	sink3 = (float)(cp->sink3) / 100.f;
	max_ballast = (float)(cp->max_ballast) * 2.f;
	wingarea = (float)(cp->wingarea) / 100.f;
}


const t_polar Polars::getPolar( int x ) {
	return t_polar(&polars_default_arr[x]);
}

int Polars::numPolars() {
	return(  sizeof( polars_default_arr ) / sizeof(compressed_polar) );
}

void Polars::begin(){
	ESP_LOGI( FNAME,"Polars::begin() configured glider type:%d, index:%d", glider_type.get(), glider_type_index.get() );
	if( glider_type_index.get() == 0 ){
		ESP_LOGI( FNAME,"Need first to initialize unique glider type index: %d", polars_default_arr[ glider_type.get() ].index );
		glider_type_index.set(  polars_default_arr[ glider_type.get() ].index );
	}
    int unique_glider_index = glider_type_index.get();
	if( polars_default_arr[ glider_type.get() ].index != unique_glider_index ){
		ESP_LOGI( FNAME,"Unique index missmatch, migrate index after polar DB change");
		for( int p=0; p<numPolars(); p++ ){
			if( polars_default_arr[p].index == unique_glider_index ){
				ESP_LOGI( FNAME,"Found Glider index %d at new position %d (old:%d)", unique_glider_index, p, glider_type.get() );
				if( glider_type.get() != p )
					glider_type.set( p );
				break;
			}
		}
	}
}

